{% extends "base.html" %}

{% block title %}新建需求 - {{ project.name }}{% endblock %}

{% block header %}
<div class="page-header">
    <h1>{{ project.name }} - 新建需求</h1>
</div>
{% endblock %}

{% block content %}
<div class="card form-card">
    <div class="card-body">
        <form id="story-form" onsubmit="return handleSubmit(event)">
            <div class="form-group">
                <label for="title">标题 *</label>
                <input type="text" id="title" name="title" class="form-control" required
                       placeholder="例如：添加用户认证功能">
            </div>

            <div class="form-group">
                <label for="requirement">需求描述 *</label>
                <textarea id="requirement" name="requirement" class="form-control" rows="6" required
                          placeholder="描述需要实现的功能..."></textarea>
                <div class="hint">详细描述需要开发的功能或变更。</div>
            </div>

            <div class="form-group">
                <label for="acceptance_criteria">验收标准</label>
                <textarea id="acceptance_criteria" name="acceptance_criteria" class="form-control" rows="4"
                          placeholder="- 用户可以通过邮箱注册&#10;- 用户可以登录&#10;- 会话在页面刷新后保持"></textarea>
                <div class="hint">列出需求完成的验收条件。</div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">创建需求</button>
                <a href="/projects/{{ project.id }}" class="btn btn-secondary">取消</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var PROJECT_ID = "{{ project.id }}";

async function handleSubmit(e) {
    e.preventDefault();
    var form = document.getElementById('story-form');
    var data = {
        project_id: PROJECT_ID,
        title: form.title.value.trim(),
        requirement: form.requirement.value.trim(),
        acceptance_criteria: form.acceptance_criteria.value.trim() || null,
    };
    if (!data.title || !data.requirement) {
        showToast('标题和需求描述为必填项', 'error');
        return false;
    }
    try {
        var result = await apiCall('/api/projects/' + PROJECT_ID + '/stories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        showToast('需求创建成功');
        window.location.href = '/stories/' + result.id;
    } catch (err) {
        // error already shown by apiCall
    }
    return false;
}
</script>
{% endblock %}

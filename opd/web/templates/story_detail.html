{% extends "base.html" %}

{% set STATUS_CN = {
    'created': '已创建',
    'clarifying': '需求澄清',
    'planning': '方案规划',
    'coding': 'AI 编码中',
    'pr_created': 'PR 已创建',
    'reviewing': '代码审查',
    'revising': 'AI 修改中',
    'testing': '人工验证',
    'done': '已完成'
} %}
{% set STORY_STATUS_CN = {
    'created': '待处理',
    'in_progress': '进行中',
    'done': '已完成',
    'cancelled': '已关闭'
} %}

{% set STEPS = ['clarifying', 'planning', 'coding', 'reviewing', 'done'] %}
{% set STEP_LABELS = {
    'clarifying': '澄清需求',
    'planning': '规划方案',
    'coding': 'AI 编码',
    'reviewing': '审查合并',
    'done': '完成'
} %}

{% block title %}{{ story.title }}{% endblock %}

{% block header %}
<div class="page-header" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
    <h1 style="margin:0;">{{ story.title }}</h1>
    <span class="badge badge-{{ story.status.value }}">
        {{ STORY_STATUS_CN.get(story.status.value, story.status.value) }}
    </span>
    {% if story.status.value not in ('done', 'cancelled') %}
    <button class="btn btn-sm btn-secondary" onclick="closeStory()" style="margin-left:auto; font-size:0.75rem;">关闭需求</button>
    {% endif %}
</div>
{% endblock %}

{% block content %}
{# Macro: task status bar showing elapsed time and heartbeat #}
{% macro task_status_bar() %}
{% if last_activity_at %}
{% set elapsed = (now - last_activity_at).total_seconds()|int %}
<div class="task-status-bar" style="margin-top:10px; padding:8px 12px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.8rem; color:var(--text-muted); display:flex; align-items:center; gap:12px;">
    <span id="heartbeat-dot" style="width:8px; height:8px; border-radius:50%; background:#22c55e; flex-shrink:0;"></span>
    <span>最近活动: {{ elapsed // 60 }}分{{ elapsed % 60 }}秒前</span>
    <span id="task-alive-label" style="margin-left:auto;">检测中...</span>
</div>
<script>
(function() {
    fetch('/api/stories/' + STORY_ID + '/task-status')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var dot = document.getElementById('heartbeat-dot');
            var label = document.getElementById('task-alive-label');
            if (d.running) {
                dot.style.background = '#22c55e';
                label.textContent = '后台任务运行中';
                label.style.color = '#22c55e';
            } else {
                dot.style.background = '#ef4444';
                label.textContent = '后台任务未运行';
                label.style.color = '#ef4444';
            }
        })
        .catch(function() {
            var label = document.getElementById('task-alive-label');
            if (label) label.textContent = '状态未知';
        });
})();
</script>
{% endif %}
{% endmacro %}
<!-- Progress stepper -->
{% if active_round %}
{% set cur = active_round.status.value %}
{% set step_map = {
    'created': 0,
    'clarifying': 0,
    'planning': 1,
    'coding': 2,
    'pr_created': 3,
    'reviewing': 3,
    'revising': 3,
    'testing': 3,
    'done': 4
} %}
{% set cur_idx = step_map.get(cur, 0) %}
<div class="section">
    <div class="progress-bar-wrap">
        {% for step in STEPS %}
        <div class="pb-step {% if loop.index0 < cur_idx %}done{% elif loop.index0 == cur_idx %}current{% endif %}">
            <div class="pb-dot">{% if loop.index0 < cur_idx %}<svg width="12" height="12" viewBox="0 0 12 12"><path d="M2 6l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>{% else %}{{ loop.index }}{% endif %}</div>
            <div class="pb-label">{{ STEP_LABELS[step] }}</div>
        </div>
        {% if not loop.last %}
        <div class="pb-line {% if loop.index0 < cur_idx %}done{% endif %}"></div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Current status & actions -->
{% if active_round %}
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>
                第 {{ active_round.round_number }} 轮 &mdash;
                {{ STATUS_CN.get(active_round.status.value, active_round.status.value) }}
            </h2>
        </div>
        <div class="card-body">

            {# ---- ERROR BANNER (shown in any state) ---- #}
            {% if error_message %}
            <div style="margin-bottom:12px; padding:10px 14px; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; font-size:0.85rem; color:#991b1b;">
                <strong>错误：</strong>{{ error_message }}
            </div>
            {% endif %}

            {# ---- CLARIFYING ---- #}
            {% if cur == 'clarifying' %}
            {% if active_round.clarifications %}
            <div class="status-hint">AI 分析了需求，提出了以下问题。请回答后继续。</div>
            <div class="clarification-list" style="margin:16px 0;">
                {% for c in active_round.clarifications %}
                <div class="clarification-item" id="clarification-{{ c.id }}">
                    <div class="clarification-q"><strong>Q:</strong> {{ c.question }}</div>
                    {% if c.answer %}
                    <div class="clarification-a"><strong>A:</strong> {{ c.answer }}</div>
                    {% else %}
                    <div class="answer-input" style="margin-top:6px;">
                        <input type="text" class="form-control answer-field" data-id="{{ c.id }}" placeholder="输入你的回答...">
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="submitAnswers()">提交回答</button>
                <button class="btn btn-secondary" onclick="skipClarify()">跳过澄清，直接规划</button>
            </div>
            {% else %}
            <div class="status-hint">
                <span class="spinner"></span>
                AI 正在分析需求，请稍候...
            </div>
            {{ task_status_bar() }}
            <script>setTimeout(function(){ location.reload(); }, 5000);</script>
            {% endif %}

            {# ---- PLANNING ---- #}
            {% elif cur == 'planning' %}
                {% if plan_content %}
                <div class="status-hint">AI 已生成实施方案，请审阅后确认或驳回。</div>
                <div class="plan-display" style="margin:12px 0;">
                    {% if plan_steps %}
                    <div style="background:var(--bg-secondary, #f8fafc); padding:16px; border-radius:6px;">
                        <h4 style="font-size:0.9rem; margin-bottom:12px; color:var(--text-primary);">实施步骤</h4>
                        <ol style="padding-left:20px; margin:0;">
                            {% for step in plan_steps %}
                            <li style="margin-bottom:10px; font-size:0.9rem;">
                                <div>{{ step.description }}</div>
                                {% if step.files %}
                                <div style="margin-top:4px;">
                                    {% for f in step.files %}
                                    <code style="font-size:0.8rem; background:#e2e8f0; padding:1px 6px; border-radius:3px; margin-right:4px;">{{ f }}</code>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ol>
                    </div>
                    {% else %}
                    <pre style="white-space:pre-wrap; font-size:0.85rem; background:var(--bg-secondary, #f8fafc); padding:12px; border-radius:6px; max-height:400px; overflow-y:auto;">{{ plan_content }}</pre>
                    {% endif %}
                </div>
                <div class="btn-group" style="margin-top:12px;">
                    <button class="btn btn-success" onclick="confirmPlan(true)">确认方案，开始编码</button>
                    <button class="btn btn-warning" onclick="confirmPlan(false)">驳回，要求重新规划</button>
                    <button class="btn btn-secondary" onclick="generatePlan()">重新生成方案</button>
                </div>
                {% else %}
                <div class="status-hint">
                    <span class="spinner"></span>
                    AI 正在生成实施方案，请稍候...
                </div>
                {{ task_status_bar() }}
                <div class="btn-group" style="margin-top:12px;">
                    <button class="btn btn-secondary btn-sm" onclick="generatePlan()">重新触发生成</button>
                </div>
                <script>setTimeout(function(){ location.reload(); }, 5000);</script>
                {% endif %}

            {# ---- CODING ---- #}
            {% elif cur == 'coding' %}
            <div id="coding-status-hint" class="status-hint">
                <span class="spinner"></span>
                AI 正在编码中，完成后会自动创建 PR。
            </div>
            <div id="coding-orphan-warning" style="display:none; margin-top:8px; padding:10px 14px; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; font-size:0.85rem; color:#991b1b;">
                <strong>⚠ 后台任务已中断</strong>（可能因服务器重启）。请回退到规划阶段重新开始编码。
            </div>
            {{ task_status_bar() }}
            {% if coding_msg_count > 0 %}
            <div style="margin-top:12px; padding:10px 14px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.85rem;">
                <div style="color:var(--text-muted);">已收到 {{ coding_msg_count }} 条 AI 消息</div>
                {% if latest_activity %}
                <div style="margin-top:6px; color:var(--text-primary);">{{ latest_activity }}</div>
                {% endif %}
            </div>
            {% endif %}
            <div style="margin-top:12px;">
                <button class="btn btn-secondary btn-sm" onclick="toggleAILog()" style="font-size:0.8rem;">查看 AI 交互日志</button>
            </div>
            <div id="ai-log-panel" style="display:none; margin-top:8px; max-height:400px; overflow-y:auto; background:var(--bg-secondary, #f8fafc); border:1px solid var(--border); border-radius:6px; padding:10px; font-size:0.8rem; font-family:monospace;">
                <div id="ai-log-list" style="color:var(--text-muted);">加载中...</div>
            </div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-danger btn-sm" onclick="stopTask()">紧急停止</button>
                <button class="btn btn-secondary btn-sm" onclick="resetToPlanning()">回退到规划阶段</button>
            </div>
            <script>
            (function() {
                fetch('/api/stories/' + STORY_ID + '/task-status')
                    .then(function(r) { return r.json(); })
                    .then(function(d) {
                        if (!d.running) {
                            document.getElementById('coding-status-hint').style.display = 'none';
                            document.getElementById('coding-orphan-warning').style.display = 'block';
                            // One more refresh to pick up any error messages
                            setTimeout(function(){ location.reload(); }, 5000);
                        } else {
                            setTimeout(function(){ location.reload(); }, 8000);
                        }
                    })
                    .catch(function() {
                        setTimeout(function(){ location.reload(); }, 8000);
                    });
            })();
            </script>

            {# ---- PR_CREATED / REVIEWING ---- #}
            {% elif cur in ('pr_created', 'reviewing') %}
            {% if active_round.pr_url %}
            <div class="status-hint">
                代码已提交，PR 已创建。请审查代码后选择操作。
                <a href="{{ active_round.pr_url }}" target="_blank" rel="noopener"
                   style="margin-left:8px; font-size:0.85rem;">
                    PR #{{ active_round.pr_id }}
                </a>
            </div>
            {% elif active_round.pr_id %}
            <div class="status-hint">
                代码已提交，PR #{{ active_round.pr_id }} 已创建。
            </div>
            {% else %}
            <div class="status-hint" style="color:var(--warning, #e67e22);">
                AI 编码已完成，但 PR 未成功创建。可能原因：GitHub Token 无效、网络超时、仓库权限不足。
            </div>
            {% endif %}
            <div class="btn-group" style="margin-top:12px;">
                {% if not active_round.pr_url %}
                <button class="btn btn-warning" onclick="retryPR()">重试创建 PR</button>
                {% endif %}
                <button class="btn btn-primary" onclick="showReviseModal()">要求 AI 修改</button>
                {% if active_round.pr_url %}
                <button class="btn btn-secondary" onclick="triggerTest()">进入人工验证</button>
                <button class="btn btn-success" onclick="triggerMerge()">合并 PR</button>
                {% endif %}
            </div>

            {# ---- REVISING ---- #}
            {% elif cur == 'revising' %}
            <div id="revising-status-hint" class="status-hint">
                <span class="spinner"></span>
                AI 正在根据反馈修改代码...
            </div>
            <div id="revising-orphan-warning" style="display:none; margin-top:8px; padding:10px 14px; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; font-size:0.85rem; color:#991b1b;">
                <strong>⚠ 后台任务已中断</strong>（可能因服务器重启）。请回退到审查阶段重新操作。
            </div>
            {{ task_status_bar() }}
            {% if latest_activity %}
            <div style="margin-top:12px; padding:10px 14px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.85rem;">
                <div style="color:var(--text-primary);">{{ latest_activity }}</div>
            </div>
            {% endif %}
            <div style="margin-top:12px;">
                <button class="btn btn-secondary btn-sm" onclick="toggleAILog()" style="font-size:0.8rem;">查看 AI 交互日志</button>
            </div>
            <div id="ai-log-panel" style="display:none; margin-top:8px; max-height:400px; overflow-y:auto; background:var(--bg-secondary, #f8fafc); border:1px solid var(--border); border-radius:6px; padding:10px; font-size:0.8rem; font-family:monospace;">
                <div id="ai-log-list" style="color:var(--text-muted);">加载中...</div>
            </div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-danger btn-sm" onclick="stopTask()">紧急停止</button>
                <button class="btn btn-secondary btn-sm" onclick="resetToReviewing()">回退到审查阶段</button>
            </div>
            <script>
            (function() {
                fetch('/api/stories/' + STORY_ID + '/task-status')
                    .then(function(r) { return r.json(); })
                    .then(function(d) {
                        if (!d.running) {
                            document.getElementById('revising-status-hint').style.display = 'none';
                            document.getElementById('revising-orphan-warning').style.display = 'block';
                            setTimeout(function(){ location.reload(); }, 5000);
                        } else {
                            setTimeout(function(){ location.reload(); }, 8000);
                        }
                    })
                    .catch(function() {
                        setTimeout(function(){ location.reload(); }, 8000);
                    });
            })();
            </script>

            {# ---- TESTING (Manual Verification) ---- #}
            {% elif cur == 'testing' %}
            <div class="status-hint">请在本地拉取分支进行人工验证，完成后选择操作。</div>
            <div style="margin:12px 0; padding:12px 16px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.85rem;">
                {% if active_round.branch_name %}
                <div style="margin-bottom:8px;">
                    <strong>分支：</strong>
                    <code style="background:#e2e8f0; padding:2px 8px; border-radius:3px;">{{ active_round.branch_name }}</code>
                </div>
                <div style="margin-bottom:8px; color:var(--text-muted); font-size:0.8rem;">
                    <code>git fetch origin && git checkout {{ active_round.branch_name }}</code>
                </div>
                {% endif %}
                {% if active_round.pr_url %}
                <div>
                    <strong>PR：</strong>
                    <a href="{{ active_round.pr_url }}" target="_blank" rel="noopener">
                        PR #{{ active_round.pr_id }}
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-success" onclick="verifyPass()">验证通过，合并 PR</button>
                <button class="btn btn-warning" onclick="showVerifyFailModal()">验证不通过</button>
                <button class="btn btn-secondary btn-sm" onclick="backToReview()">返回审查</button>
            </div>

            {# ---- DONE ---- #}
            {% elif cur == 'done' %}
            <div class="status-hint" style="color:var(--success);">本轮已完成。</div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-primary" onclick="showNewRoundModal()">开始新一轮迭代</button>
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endif %}

<!-- Story info (collapsible) -->
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>需求信息</h2>
            <a href="/projects/{{ story.project_id }}" class="btn btn-sm btn-secondary">返回项目</a>
        </div>
        <div class="card-body">
            <dl class="info-grid">
                <dt>需求描述</dt>
                <dd>{{ story.requirement }}</dd>
                {% if story.acceptance_criteria %}
                <dt>验收标准</dt>
                <dd style="white-space:pre-wrap;">{{ story.acceptance_criteria }}</dd>
                {% endif %}
                <dt>当前轮次</dt>
                <dd>第 {{ story.current_round }} 轮</dd>
            </dl>
        </div>
    </div>
</div>

<!-- AI Activity Log (collapsed, human-readable) -->
{% if ai_messages %}
{% set readable_msgs = [] %}
{% for msg in ai_messages %}
    {% set role = msg.role.value if msg.role.value is defined else msg.role %}
    {% set c = msg.content %}
    {% set ts = msg.created_at.strftime('%Y-%m-%d %H:%M') %}
    {% if '[Implementation Plan]' in c or '[Revised Plan]' in c %}
        {% set _ = readable_msgs.append({'icon': 'plan', 'text': 'AI 生成了实施方案', 'time': ts}) %}
    {% elif '[Plan Feedback]' in c %}
        {% set _ = readable_msgs.append({'icon': 'user', 'text': '用户反馈：' ~ c.replace('[Plan Feedback] ', ''), 'time': ts}) %}
    {% elif '[Revision Request]' in c %}
        {% set _ = readable_msgs.append({'icon': 'user', 'text': '修改请求：' ~ c.replace('[Revision Request] ', '')[:200], 'time': ts}) %}
    {% elif '[PR Created]' in c %}
        {% set _ = readable_msgs.append({'icon': 'plan', 'text': c.replace('[PR Created] ', ''), 'time': ts}) %}
    {% elif '[Code Pushed]' in c %}
        {% set _ = readable_msgs.append({'icon': 'plan', 'text': c.replace('[Code Pushed] ', ''), 'time': ts}) %}
    {% elif '[Task Started]' in c %}
        {% set _ = readable_msgs.append({'icon': 'ai', 'text': c.replace('[Task Started] ', ''), 'time': ts}) %}
    {% elif '[Stopped]' in c %}
        {% set _ = readable_msgs.append({'icon': 'error', 'text': c.replace('[Stopped] ', ''), 'time': ts}) %}
    {% elif '[CI Pipeline]' in c %}
        {% set _ = readable_msgs.append({'icon': 'tool', 'text': '触发了 CI 流水线', 'time': ts}) %}
    {% elif '[Error]' in c %}
        {% set _ = readable_msgs.append({'icon': 'error', 'text': c, 'time': ts}) %}
    {% elif role == 'tool' %}
        {# skip raw tool JSON #}
    {% elif role == 'assistant' and c|length < 500 %}
        {% set _ = readable_msgs.append({'icon': 'ai', 'text': c[:200], 'time': ts}) %}
    {% endif %}
{% endfor %}
{% if readable_msgs %}
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>活动记录</h2>
        </div>
        <div class="card-body">
            <div style="display:flex; flex-direction:column; gap:8px;">
                {% for m in readable_msgs %}
                <div style="display:flex; align-items:flex-start; gap:8px; font-size:0.85rem; padding:6px 0; border-bottom:1px solid var(--border);">
                    {% if m.icon == 'plan' %}
                    <span style="color:var(--accent); flex-shrink:0;">&#9679;</span>
                    {% elif m.icon == 'user' %}
                    <span style="color:var(--success); flex-shrink:0;">&#9679;</span>
                    {% elif m.icon == 'error' %}
                    <span style="color:var(--danger); flex-shrink:0;">&#9679;</span>
                    {% else %}
                    <span style="color:var(--text-muted); flex-shrink:0;">&#9679;</span>
                    {% endif %}
                    <span style="flex:1;">{{ m.text }}</span>
                    <span style="color:var(--text-muted); flex-shrink:0; font-size:0.75rem; white-space:nowrap;">{{ m.time }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Rounds history (only show if multiple rounds) -->
{% if story.rounds|length > 1 %}
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>历史轮次</h2>
        </div>
        <div class="card-body">
            {% for round in story.rounds|sort(attribute='round_number', reverse=True) %}
            <div class="round-item {% if active_round and round.id == active_round.id %}active{% endif %}" style="padding:8px 0; border-bottom:1px solid var(--border-color);">
                <span>第 {{ round.round_number }} 轮</span>
                <span class="badge badge-{{ round.status.value }}" style="margin-left:8px;">
                    {{ STATUS_CN.get(round.status.value, round.status.value) }}
                </span>
                {% if round.branch_name %}
                <span style="font-size:0.8rem; color:var(--text-muted); margin-left:8px;">{{ round.branch_name }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Revise modal -->
<div id="revise-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
    <div class="card" style="width:480px; max-width:90vw;">
        <div class="card-header">
            <h2>要求 AI 修改</h2>
            <button class="btn btn-sm btn-secondary" onclick="hideReviseModal()">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="revise-mode">修改依据</label>
                <select id="revise-mode" class="form-control">
                    <option value="prompt">自定义指令</option>
                    <option value="comments">根据 PR 评论</option>
                </select>
            </div>
            <div class="form-group">
                <label for="revise-prompt">修改指令</label>
                <textarea id="revise-prompt" class="form-control" rows="3" placeholder="描述需要修改的内容..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitRevise()">提交</button>
        </div>
    </div>
</div>

<!-- New round modal -->
<div id="new-round-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
    <div class="card" style="width:480px; max-width:90vw;">
        <div class="card-header">
            <h2>开始新一轮</h2>
            <button class="btn btn-sm btn-secondary" onclick="hideNewRoundModal()">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="round-type">类型</label>
                <select id="round-type" class="form-control">
                    <option value="iterate">迭代优化</option>
                    <option value="restart">推倒重来</option>
                </select>
            </div>
            <div class="form-group">
                <label for="round-requirement">更新需求（可选）</label>
                <textarea id="round-requirement" class="form-control" rows="3" placeholder="如需修改需求描述，在此输入..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitNewRound()">开始</button>
        </div>
    </div>
</div>
<!-- Verify fail modal -->
<div id="verify-fail-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
    <div class="card" style="width:480px; max-width:90vw;">
        <div class="card-header">
            <h2>验证不通过</h2>
            <button class="btn btn-sm btn-secondary" onclick="hideVerifyFailModal()">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="verify-feedback">问题描述（将作为 AI 修改指令）</label>
                <textarea id="verify-feedback" class="form-control" rows="4" placeholder="描述验证中发现的问题..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitVerifyFail()">提交并要求 AI 修改</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var STORY_ID = "{{ story.id }}";
var _autoRefreshTimer = null;

function startAutoRefresh(interval) {
    if (_autoRefreshTimer) clearInterval(_autoRefreshTimer);
    _autoRefreshTimer = setInterval(function() { location.reload(); }, interval);
}

function stopAutoRefresh() {
    if (_autoRefreshTimer) { clearInterval(_autoRefreshTimer); _autoRefreshTimer = null; }
}

async function submitAnswers() {
    var fields = document.querySelectorAll('.answer-field');
    var answers = {};
    fields.forEach(function(f) {
        var val = f.value.trim();
        if (val) answers[f.dataset.id] = val;
    });
    if (fields.length > 0 && Object.keys(answers).length === 0) {
        showToast('请至少回答一个问题', 'error');
        return;
    }
    await apiCall('/api/stories/' + STORY_ID + '/answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ answers: answers })
    });
    showToast('回答已提交');
    location.reload();
}

async function skipClarify() {
    await apiCall('/api/stories/' + STORY_ID + '/answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ answers: {} })
    });
    showToast('已跳过澄清，进入规划阶段');
    location.reload();
}

async function generatePlan() {
    try {
        await apiCall('/api/stories/' + STORY_ID + '/generate-plan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        showToast('方案生成已启动，AI 处理中...');
        location.reload();
    } catch(e) {
        showToast('请求失败: ' + (e.message || '未知错误'), 'error');
    }
}

async function confirmPlan(confirmed) {
    var feedback = null;
    if (!confirmed) {
        feedback = prompt('请输入反馈意见，告诉 AI 哪里需要改进：');
        if (feedback === null) return;
    }
    await apiCall('/api/stories/' + STORY_ID + '/confirm-plan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ confirmed: confirmed, feedback: feedback })
    });
    if (confirmed) {
        showToast('方案已确认，AI 开始编码');
    } else {
        showToast('方案已驳回，AI 正在重新规划...');
    }
    location.reload();
}

function showReviseModal() { document.getElementById('revise-modal').style.display = 'flex'; }
function hideReviseModal() { document.getElementById('revise-modal').style.display = 'none'; }

async function submitRevise() {
    var mode = document.getElementById('revise-mode').value;
    var prompt_text = document.getElementById('revise-prompt').value.trim() || null;
    await apiCall('/api/stories/' + STORY_ID + '/revise', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mode: mode, prompt: prompt_text })
    });
    showToast('修改请求已提交');
    hideReviseModal();
    location.reload();
}

async function triggerTest() {
    await apiCall('/api/stories/' + STORY_ID + '/test', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
    });
    showToast('测试已触发');
    location.reload();
}

async function triggerMerge() {
    if (!confirm('确定合并此 PR？')) return;
    await apiCall('/api/stories/' + STORY_ID + '/merge', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
    });
    showToast('PR 已合并');
    location.reload();
}

async function verifyPass() {
    if (!confirm('验证通过，确定合并此 PR？')) return;
    await apiCall('/api/stories/' + STORY_ID + '/merge', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
    });
    showToast('验证通过，PR 已合并');
    location.reload();
}

function showVerifyFailModal() { document.getElementById('verify-fail-modal').style.display = 'flex'; }
function hideVerifyFailModal() { document.getElementById('verify-fail-modal').style.display = 'none'; }

async function submitVerifyFail() {
    var feedback = document.getElementById('verify-feedback').value.trim();
    if (!feedback) { showToast('请填写问题描述', 'error'); return; }
    await apiCall('/api/stories/' + STORY_ID + '/revise', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mode: 'prompt', prompt: '[验证不通过] ' + feedback })
    });
    showToast('已提交修改请求');
    hideVerifyFailModal();
    location.reload();
}

async function backToReview() {
    await apiCall('/api/stories/' + STORY_ID + '/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ target_status: 'reviewing' })
    });
    showToast('已返回审查阶段');
    location.reload();
}

async function resetToPlanning() {
    if (!confirm('确定回退到规划阶段？当前编码进度将丢失。')) return;
    await apiCall('/api/stories/' + STORY_ID + '/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ target_status: 'planning' })
    });
    showToast('已回退到规划阶段');
    location.reload();
}

async function stopTask() {
    if (!confirm('确定紧急停止当前 AI 任务？')) return;
    try {
        await apiCall('/api/stories/' + STORY_ID + '/stop', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        showToast('已停止当前任务');
        location.reload();
    } catch(e) {
        showToast('停止失败: ' + (e.message || '未知错误'), 'error');
    }
}

async function retryPR() {
    try {
        showToast('正在重试创建 PR...');
        await apiCall('/api/stories/' + STORY_ID + '/retry-pr', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        showToast('PR 创建成功');
        location.reload();
    } catch(e) {
        showToast('重试失败: ' + (e.message || '未知错误'), 'error');
    }
}

async function resetToReviewing() {
    if (!confirm('确定回退到审查阶段？')) return;
    await apiCall('/api/stories/' + STORY_ID + '/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ target_status: 'reviewing' })
    });
    showToast('已回退到审查阶段');
    location.reload();
}

function showNewRoundModal() { document.getElementById('new-round-modal').style.display = 'flex'; }
function hideNewRoundModal() { document.getElementById('new-round-modal').style.display = 'none'; }

async function submitNewRound() {
    var type = document.getElementById('round-type').value;
    var requirement = document.getElementById('round-requirement').value.trim() || null;
    await apiCall('/api/stories/' + STORY_ID + '/new-round', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ type: type, requirement: requirement })
    });
    showToast('新一轮已开始');
    hideNewRoundModal();
    location.reload();
}

function refreshLogs() {
    var logList = document.getElementById('ai-log-list');
    if (!logList) return;
    logList.innerHTML = '<div style="color:var(--text-muted);">加载中...</div>';
    var es = new EventSource('/api/stories/' + STORY_ID + '/logs');
    var messages = [];
    es.onmessage = function(event) {
        var data = JSON.parse(event.data);
        if (data.type === 'done') { es.close(); if (messages.length === 0) logList.innerHTML = '<div style="color:var(--text-muted);">暂无消息</div>'; return; }
        if (data.type === 'info') { logList.innerHTML = '<div style="color:var(--text-muted);">' + data.message + '</div>'; es.close(); return; }
        messages.push(data);
        if (messages.length === 1) logList.innerHTML = '';
        var roleMap = {assistant:'AI', user:'用户', tool:'工具'};
        var div = document.createElement('div');
        div.className = 'ai-log-item role-' + data.role;
        var content = data.content.length > 300 ? data.content.substring(0, 300) + '...' : data.content;
        div.innerHTML = '<span class="ai-log-role">' + (roleMap[data.role]||data.role) + '</span>' + escapeHtml(content);
        logList.appendChild(div);
        logList.scrollTop = logList.scrollHeight;
    };
    es.onerror = function() { es.close(); };
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}

async function closeStory() {
    if (!confirm('确定关闭此需求？关闭后可在项目页面重新打开。')) return;
    try {
        await apiCall('/api/stories/' + STORY_ID + '/close', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
        });
        showToast('需求已关闭');
        location.reload();
    } catch(e) {
        showToast('关闭失败: ' + (e.message || '未知错误'), 'error');
    }
}

function toggleAILog() {
    var panel = document.getElementById('ai-log-panel');
    if (!panel) return;
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        refreshLogs();
    } else {
        panel.style.display = 'none';
    }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% set STATUS_CN = {
    'created': 'å·²åˆ›å»º',
    'clarifying': 'éœ€æ±‚æ¾„æ¸…',
    'planning': 'æ–¹æ¡ˆè§„åˆ’',
    'coding': 'AI ç¼–ç ä¸­',
    'pr_created': 'PR å·²åˆ›å»º',
    'reviewing': 'ä»£ç å®¡æŸ¥',
    'revising': 'AI ä¿®æ”¹ä¸­',
    'testing': 'äººå·¥éªŒè¯',
    'done': 'å·²å®Œæˆ'
} %}
{% set STORY_STATUS_CN = {
    'created': 'å¾…å¤„ç†',
    'in_progress': 'è¿›è¡Œä¸­',
    'done': 'å·²å®Œæˆ',
    'cancelled': 'å·²å…³é—­'
} %}

{% set STEPS = ['clarifying', 'planning', 'coding', 'reviewing', 'done'] %}
{% set STEP_LABELS = {
    'clarifying': 'æ¾„æ¸…éœ€æ±‚',
    'planning': 'è§„åˆ’æ–¹æ¡ˆ',
    'coding': 'AI ç¼–ç ',
    'reviewing': 'å®¡æŸ¥åˆå¹¶',
    'done': 'å®Œæˆ'
} %}

{% block title %}{{ story.title }}{% endblock %}

{% block header %}
<div class="page-header" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
    <h1 style="margin:0;">{{ story.title }}</h1>
    <span class="badge badge-{{ story.status.value }}">
        {{ STORY_STATUS_CN.get(story.status.value, story.status.value) }}
    </span>
    {% if story.status.value not in ('done', 'cancelled') %}
    <button class="btn btn-sm btn-secondary" onclick="closeStory()" style="margin-left:auto; font-size:0.75rem;">å…³é—­éœ€æ±‚</button>
    {% endif %}
</div>
{% endblock %}

{% block content %}
{# Macro: task status bar showing elapsed time and heartbeat #}
{% macro task_status_bar() %}
{% if last_activity_at %}
{% set elapsed = (now - last_activity_at).total_seconds()|int %}
<div class="task-status-bar" style="margin-top:10px; padding:8px 12px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.8rem; color:var(--text-muted); display:flex; align-items:center; gap:12px;">
    <span id="heartbeat-dot" style="width:8px; height:8px; border-radius:50%; background:#22c55e; flex-shrink:0;"></span>
    <span>æœ€è¿‘æ´»åŠ¨: {{ elapsed // 60 }}åˆ†{{ elapsed % 60 }}ç§’å‰</span>
    <span id="task-alive-label" style="margin-left:auto;">æ£€æµ‹ä¸­...</span>
</div>
<script>
(function() {
    fetch('/api/stories/' + STORY_ID + '/task-status')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var dot = document.getElementById('heartbeat-dot');
            var label = document.getElementById('task-alive-label');
            if (d.running) {
                dot.style.background = '#22c55e';
                label.textContent = 'åå°ä»»åŠ¡è¿è¡Œä¸­';
                label.style.color = '#22c55e';
            } else {
                dot.style.background = '#ef4444';
                label.textContent = 'åå°ä»»åŠ¡æœªè¿è¡Œ';
                label.style.color = '#ef4444';
            }
        })
        .catch(function() {
            var label = document.getElementById('task-alive-label');
            if (label) label.textContent = 'çŠ¶æ€æœªçŸ¥';
        });
})();
</script>
{% endif %}
{% endmacro %}
<!-- Progress stepper -->
{% if active_round %}
{% set cur = active_round.status.value %}
{% set step_map = {
    'created': 0,
    'clarifying': 0,
    'planning': 1,
    'coding': 2,
    'pr_created': 3,
    'reviewing': 3,
    'revising': 3,
    'testing': 3,
    'done': 4
} %}
{% set cur_idx = step_map.get(cur, 0) %}
<div class="section">
    <div class="progress-bar-wrap">
        {% for step in STEPS %}
        <div class="pb-step {% if loop.index0 < cur_idx %}done{% elif loop.index0 == cur_idx %}current{% endif %}">
            <div class="pb-dot">{% if loop.index0 < cur_idx %}<svg width="12" height="12" viewBox="0 0 12 12"><path d="M2 6l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>{% else %}{{ loop.index }}{% endif %}</div>
            <div class="pb-label">{{ STEP_LABELS[step] }}</div>
        </div>
        {% if not loop.last %}
        <div class="pb-line {% if loop.index0 < cur_idx %}done{% endif %}"></div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Current status & actions -->
{% if active_round %}
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>
                ç¬¬ {{ active_round.round_number }} è½® &mdash;
                {{ STATUS_CN.get(active_round.status.value, active_round.status.value) }}
            </h2>
        </div>
        <div class="card-body">

            {# ---- ERROR BANNER (shown in any state) ---- #}
            {% if error_message %}
            <div style="margin-bottom:12px; padding:10px 14px; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; font-size:0.85rem; color:#991b1b;">
                <strong>é”™è¯¯ï¼š</strong>{{ error_message }}
            </div>
            {% endif %}

            {# ---- CLARIFYING ---- #}
            {% if cur == 'clarifying' %}
            {% if active_round.clarifications %}
            <div class="status-hint">AI åˆ†æäº†éœ€æ±‚ï¼Œæå‡ºäº†ä»¥ä¸‹é—®é¢˜ã€‚è¯·å›ç­”åç»§ç»­ã€‚</div>
            <div class="clarification-list" style="margin:16px 0;">
                {% for c in active_round.clarifications %}
                <div class="clarification-item" id="clarification-{{ c.id }}">
                    <div class="clarification-q"><strong>Q:</strong> {{ c.question }}</div>
                    {% if c.answer %}
                    <div class="clarification-a"><strong>A:</strong> {{ c.answer }}</div>
                    {% else %}
                    <div class="answer-input" style="margin-top:6px;">
                        <input type="text" class="form-control answer-field" data-id="{{ c.id }}" placeholder="è¾“å…¥ä½ çš„å›ç­”...">
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="submitAnswers()">æäº¤å›ç­”</button>
                <button class="btn btn-secondary" onclick="skipClarify()">è·³è¿‡æ¾„æ¸…ï¼Œç›´æ¥è§„åˆ’</button>
            </div>
            {% else %}
            <div class="status-hint">
                <span class="spinner"></span>
                AI æ­£åœ¨åˆ†æéœ€æ±‚ï¼Œè¯·ç¨å€™...
            </div>
            {{ task_status_bar() }}
            <script>setTimeout(function(){ location.reload(); }, 5000);</script>
            {% endif %}

            {# ---- PLANNING ---- #}
            {% elif cur == 'planning' %}
                {% if plan_content %}
                <div class="status-hint">AI å·²ç”Ÿæˆå®æ–½æ–¹æ¡ˆï¼Œè¯·å®¡é˜…åç¡®è®¤æˆ–é©³å›ã€‚</div>
                <div class="plan-display" style="margin:12px 0;">
                    {% if plan_steps %}
                    <div style="background:var(--bg-secondary, #f8fafc); padding:16px; border-radius:6px;">
                        <h4 style="font-size:0.9rem; margin-bottom:12px; color:var(--text-primary);">å®æ–½æ­¥éª¤</h4>
                        <ol style="padding-left:20px; margin:0;">
                            {% for step in plan_steps %}
                            <li style="margin-bottom:10px; font-size:0.9rem;">
                                <div>{{ step.description }}</div>
                                {% if step.files %}
                                <div style="margin-top:4px;">
                                    {% for f in step.files %}
                                    <code style="font-size:0.8rem; background:#e2e8f0; padding:1px 6px; border-radius:3px; margin-right:4px;">{{ f }}</code>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ol>
                    </div>
                    {% else %}
                    <pre style="white-space:pre-wrap; font-size:0.85rem; background:var(--bg-secondary, #f8fafc); padding:12px; border-radius:6px; max-height:400px; overflow-y:auto;">{{ plan_content }}</pre>
                    {% endif %}
                </div>
                <div class="btn-group" style="margin-top:12px;">
                    <button class="btn btn-success" onclick="confirmPlan(true)">ç¡®è®¤æ–¹æ¡ˆï¼Œå¼€å§‹ç¼–ç </button>
                    <button class="btn btn-warning" onclick="confirmPlan(false)">é©³å›ï¼Œè¦æ±‚é‡æ–°è§„åˆ’</button>
                    <button class="btn btn-secondary" onclick="generatePlan()">é‡æ–°ç”Ÿæˆæ–¹æ¡ˆ</button>
                </div>
                {% else %}
                <div class="status-hint">
                    <span class="spinner"></span>
                    AI æ­£åœ¨ç”Ÿæˆå®æ–½æ–¹æ¡ˆï¼Œè¯·ç¨å€™...
                </div>
                {{ task_status_bar() }}
                <div class="btn-group" style="margin-top:12px;">
                    <button class="btn btn-secondary btn-sm" onclick="generatePlan()">é‡æ–°è§¦å‘ç”Ÿæˆ</button>
                </div>
                <script>setTimeout(function(){ location.reload(); }, 5000);</script>
                {% endif %}

            {# ---- CODING ---- #}
            {% elif cur == 'coding' %}
            <div id="coding-status-hint" class="status-hint">
                <span class="spinner"></span>
                AI æ­£åœ¨ç¼–ç ä¸­ï¼Œå®Œæˆåä¼šè‡ªåŠ¨åˆ›å»º PRã€‚
            </div>
            <div id="coding-orphan-warning" style="display:none; margin-top:8px; padding:10px 14px; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; font-size:0.85rem; color:#991b1b;">
                <strong>âš  åå°ä»»åŠ¡å·²ä¸­æ–­</strong>ï¼ˆå¯èƒ½å› æœåŠ¡å™¨é‡å¯ï¼‰ã€‚è¯·å›é€€åˆ°è§„åˆ’é˜¶æ®µé‡æ–°å¼€å§‹ç¼–ç ã€‚
            </div>
            {{ task_status_bar() }}
            <div id="stream-stats" style="margin-top:12px; padding:10px 14px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.85rem;">
                <div style="color:var(--text-muted);">å·²æ”¶åˆ° <span id="stream-msg-count">{{ coding_msg_count or 0 }}</span> æ¡ AI æ¶ˆæ¯</div>
                <div id="stream-latest" style="margin-top:6px; color:var(--text-primary);">{% if latest_activity %}{{ latest_activity }}{% endif %}</div>
            </div>
            <div id="ai-log-panel" style="margin-top:8px; min-height:200px; max-height:500px; overflow-y:auto; background:#1e1e2e; border:1px solid var(--border); border-radius:6px; padding:12px; font-size:0.8rem; font-family:'SF Mono',Monaco,Consolas,monospace;">
                <div id="ai-log-list" style="color:#cdd6f4;"><span style="color:#6c7086;">è¿æ¥ä¸­...</span></div>
            </div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-danger btn-sm" onclick="stopTask()">ç´§æ€¥åœæ­¢</button>
                <button class="btn btn-secondary btn-sm" onclick="resetToPlanning()">å›é€€åˆ°è§„åˆ’é˜¶æ®µ</button>
            </div>
            <script>document.addEventListener('DOMContentLoaded', function() { connectStream('coding'); });</script>

            {# ---- PR_CREATED / REVIEWING ---- #}
            {% elif cur in ('pr_created', 'reviewing') %}
            {% if active_round.pr_url %}
            <div class="status-hint">
                ä»£ç å·²æäº¤ï¼ŒPR å·²åˆ›å»ºã€‚è¯·å®¡æŸ¥ä»£ç åé€‰æ‹©æ“ä½œã€‚
                <a href="{{ active_round.pr_url }}" target="_blank" rel="noopener"
                   style="margin-left:8px; font-size:0.85rem;">
                    PR #{{ active_round.pr_id }}
                </a>
            </div>
            {% elif active_round.pr_id %}
            <div class="status-hint">
                ä»£ç å·²æäº¤ï¼ŒPR #{{ active_round.pr_id }} å·²åˆ›å»ºã€‚
            </div>
            {% else %}
            <div class="status-hint" style="color:var(--warning, #e67e22);">
                AI ç¼–ç å·²å®Œæˆï¼Œä½† PR æœªæˆåŠŸåˆ›å»ºã€‚å¯èƒ½åŸå› ï¼šGitHub Token æ— æ•ˆã€ç½‘ç»œè¶…æ—¶ã€ä»“åº“æƒé™ä¸è¶³ã€‚
            </div>
            {% endif %}
            <div class="btn-group" style="margin-top:12px;">
                {% if not active_round.pr_url %}
                <button class="btn btn-warning" onclick="retryPR()">é‡è¯•åˆ›å»º PR</button>
                {% endif %}
                <button class="btn btn-primary" onclick="showReviseModal()">è¦æ±‚ AI ä¿®æ”¹</button>
                {% if active_round.pr_url %}
                <button class="btn btn-secondary" onclick="triggerTest()">è¿›å…¥äººå·¥éªŒè¯</button>
                <button class="btn btn-success" onclick="triggerMerge()">åˆå¹¶ PR</button>
                {% endif %}
            </div>

            {# ---- REVISING ---- #}
            {% elif cur == 'revising' %}
            <div id="revising-status-hint" class="status-hint">
                <span class="spinner"></span>
                AI æ­£åœ¨æ ¹æ®åé¦ˆä¿®æ”¹ä»£ç ...
            </div>
            <div id="revising-orphan-warning" style="display:none; margin-top:8px; padding:10px 14px; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px; font-size:0.85rem; color:#991b1b;">
                <strong>âš  åå°ä»»åŠ¡å·²ä¸­æ–­</strong>ï¼ˆå¯èƒ½å› æœåŠ¡å™¨é‡å¯ï¼‰ã€‚è¯·å›é€€åˆ°å®¡æŸ¥é˜¶æ®µé‡æ–°æ“ä½œã€‚
            </div>
            {{ task_status_bar() }}
            <div id="stream-stats" style="margin-top:12px; padding:10px 14px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.85rem;">
                <div style="color:var(--text-muted);">å·²æ”¶åˆ° <span id="stream-msg-count">0</span> æ¡ AI æ¶ˆæ¯</div>
                <div id="stream-latest" style="margin-top:6px; color:var(--text-primary);">{% if latest_activity %}{{ latest_activity }}{% endif %}</div>
            </div>
            <div id="ai-log-panel" style="margin-top:8px; min-height:200px; max-height:500px; overflow-y:auto; background:#1e1e2e; border:1px solid var(--border); border-radius:6px; padding:12px; font-size:0.8rem; font-family:'SF Mono',Monaco,Consolas,monospace;">
                <div id="ai-log-list" style="color:#cdd6f4;"><span style="color:#6c7086;">è¿æ¥ä¸­...</span></div>
            </div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-danger btn-sm" onclick="stopTask()">ç´§æ€¥åœæ­¢</button>
                <button class="btn btn-secondary btn-sm" onclick="resetToReviewing()">å›é€€åˆ°å®¡æŸ¥é˜¶æ®µ</button>
            </div>
            <script>document.addEventListener('DOMContentLoaded', function() { connectStream('revising'); });</script>

            {# ---- TESTING (Manual Verification) ---- #}
            {% elif cur == 'testing' %}
            <div class="status-hint">è¯·åœ¨æœ¬åœ°æ‹‰å–åˆ†æ”¯è¿›è¡Œäººå·¥éªŒè¯ï¼Œå®Œæˆåé€‰æ‹©æ“ä½œã€‚</div>
            <div style="margin:12px 0; padding:12px 16px; background:var(--bg-secondary, #f8fafc); border-radius:6px; font-size:0.85rem;">
                {% if active_round.branch_name %}
                <div style="margin-bottom:8px;">
                    <strong>åˆ†æ”¯ï¼š</strong>
                    <code style="background:#e2e8f0; padding:2px 8px; border-radius:3px;">{{ active_round.branch_name }}</code>
                </div>
                <div style="margin-bottom:8px; color:var(--text-muted); font-size:0.8rem;">
                    <code>git fetch origin && git checkout {{ active_round.branch_name }}</code>
                </div>
                {% endif %}
                {% if active_round.pr_url %}
                <div>
                    <strong>PRï¼š</strong>
                    <a href="{{ active_round.pr_url }}" target="_blank" rel="noopener">
                        PR #{{ active_round.pr_id }}
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-success" onclick="verifyPass()">éªŒè¯é€šè¿‡ï¼Œåˆå¹¶ PR</button>
                <button class="btn btn-warning" onclick="showVerifyFailModal()">éªŒè¯ä¸é€šè¿‡</button>
                <button class="btn btn-secondary btn-sm" onclick="backToReview()">è¿”å›å®¡æŸ¥</button>
            </div>

            {# ---- DONE ---- #}
            {% elif cur == 'done' %}
            <div class="status-hint" style="color:var(--success);">æœ¬è½®å·²å®Œæˆã€‚</div>
            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-primary" onclick="showNewRoundModal()">å¼€å§‹æ–°ä¸€è½®è¿­ä»£</button>
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endif %}

<!-- Story info (collapsible) -->
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>éœ€æ±‚ä¿¡æ¯</h2>
            <a href="/projects/{{ story.project_id }}" class="btn btn-sm btn-secondary">è¿”å›é¡¹ç›®</a>
        </div>
        <div class="card-body">
            <dl class="info-grid">
                <dt>éœ€æ±‚æè¿°</dt>
                <dd>{{ story.requirement }}</dd>
                {% if story.acceptance_criteria %}
                <dt>éªŒæ”¶æ ‡å‡†</dt>
                <dd style="white-space:pre-wrap;">{{ story.acceptance_criteria }}</dd>
                {% endif %}
                <dt>å½“å‰è½®æ¬¡</dt>
                <dd>ç¬¬ {{ story.current_round }} è½®</dd>
            </dl>
        </div>
    </div>
</div>

<!-- Rounds history (only show if multiple rounds) -->
{% if story.rounds|length > 1 %}
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>å†å²è½®æ¬¡</h2>
        </div>
        <div class="card-body">
            {% for round in story.rounds|sort(attribute='round_number', reverse=True) %}
            <div class="round-item {% if active_round and round.id == active_round.id %}active{% endif %}" style="padding:8px 0; border-bottom:1px solid var(--border-color);">
                <span>ç¬¬ {{ round.round_number }} è½®</span>
                <span class="badge badge-{{ round.status.value }}" style="margin-left:8px;">
                    {{ STATUS_CN.get(round.status.value, round.status.value) }}
                </span>
                {% if round.branch_name %}
                <span style="font-size:0.8rem; color:var(--text-muted); margin-left:8px;">{{ round.branch_name }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Revise modal -->
<div id="revise-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
    <div class="card" style="width:480px; max-width:90vw;">
        <div class="card-header">
            <h2>è¦æ±‚ AI ä¿®æ”¹</h2>
            <button class="btn btn-sm btn-secondary" onclick="hideReviseModal()">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="revise-mode">ä¿®æ”¹ä¾æ®</label>
                <select id="revise-mode" class="form-control">
                    <option value="prompt">è‡ªå®šä¹‰æŒ‡ä»¤</option>
                    <option value="comments">æ ¹æ® PR è¯„è®º</option>
                </select>
            </div>
            <div class="form-group">
                <label for="revise-prompt">ä¿®æ”¹æŒ‡ä»¤</label>
                <textarea id="revise-prompt" class="form-control" rows="3" placeholder="æè¿°éœ€è¦ä¿®æ”¹çš„å†…å®¹..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitRevise()">æäº¤</button>
        </div>
    </div>
</div>

<!-- New round modal -->
<div id="new-round-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
    <div class="card" style="width:480px; max-width:90vw;">
        <div class="card-header">
            <h2>å¼€å§‹æ–°ä¸€è½®</h2>
            <button class="btn btn-sm btn-secondary" onclick="hideNewRoundModal()">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="round-type">ç±»å‹</label>
                <select id="round-type" class="form-control">
                    <option value="iterate">è¿­ä»£ä¼˜åŒ–</option>
                    <option value="restart">æ¨å€’é‡æ¥</option>
                </select>
            </div>
            <div class="form-group">
                <label for="round-requirement">æ›´æ–°éœ€æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="round-requirement" class="form-control" rows="3" placeholder="å¦‚éœ€ä¿®æ”¹éœ€æ±‚æè¿°ï¼Œåœ¨æ­¤è¾“å…¥..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitNewRound()">å¼€å§‹</button>
        </div>
    </div>
</div>
<!-- Verify fail modal -->
<div id="verify-fail-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:200; align-items:center; justify-content:center;">
    <div class="card" style="width:480px; max-width:90vw;">
        <div class="card-header">
            <h2>éªŒè¯ä¸é€šè¿‡</h2>
            <button class="btn btn-sm btn-secondary" onclick="hideVerifyFailModal()">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="verify-feedback">é—®é¢˜æè¿°ï¼ˆå°†ä½œä¸º AI ä¿®æ”¹æŒ‡ä»¤ï¼‰</label>
                <textarea id="verify-feedback" class="form-control" rows="4" placeholder="æè¿°éªŒè¯ä¸­å‘ç°çš„é—®é¢˜..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitVerifyFail()">æäº¤å¹¶è¦æ±‚ AI ä¿®æ”¹</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var STORY_ID = "{{ story.id }}";
var _autoRefreshTimer = null;
var _streamSource = null;
var _streamMsgCount = 0;

function startAutoRefresh(interval) {
    if (_autoRefreshTimer) clearInterval(_autoRefreshTimer);
    _autoRefreshTimer = setInterval(function() { location.reload(); }, interval);
}

function stopAutoRefresh() {
    if (_autoRefreshTimer) { clearInterval(_autoRefreshTimer); _autoRefreshTimer = null; }
}

/* ------------------------------------------------------------------ */
/* Real-time SSE streaming for coding/revising states                 */
/* ------------------------------------------------------------------ */

function connectStream(phase) {
    var logList = document.getElementById('ai-log-list');
    var countEl = document.getElementById('stream-msg-count');
    var latestEl = document.getElementById('stream-latest');
    var statusHint = document.getElementById(phase + '-status-hint');
    var orphanWarn = document.getElementById(phase + '-orphan-warning');
    _streamMsgCount = 0;

    if (logList) logList.innerHTML = '';

    _streamSource = new EventSource('/api/stories/' + STORY_ID + '/stream');
    var historyDone = false;

    _streamSource.onmessage = function(ev) {
        var data = JSON.parse(ev.data);

        if (data.type === 'history_end') {
            historyDone = true;
            if (logList && _streamMsgCount > 0) {
                var sep = document.createElement('div');
                sep.style.cssText = 'border-top:1px dashed #585b70; margin:8px 0; padding-top:4px; color:#6c7086; font-size:0.75rem;';
                sep.textContent = 'â€” ä»¥ä¸Šä¸ºå†å²æ¶ˆæ¯ï¼Œä»¥ä¸‹ä¸ºå®æ—¶æ¶ˆæ¯ â€”';
                logList.appendChild(sep);
                scrollLog();
            }
            return;
        }

        if (data.type === 'message') {
            _streamMsgCount++;
            if (countEl) countEl.textContent = _streamMsgCount;
            appendLogEntry(logList, data);
            // Update latest activity summary
            if (latestEl && data.role === 'assistant') {
                var preview = data.content.length > 120 ? data.content.substring(0, 120) + '...' : data.content;
                latestEl.textContent = preview;
            }
            if (latestEl && data.role === 'tool') {
                try {
                    var toolData = JSON.parse(data.content);
                    latestEl.textContent = 'ğŸ”§ ' + (toolData.tool || 'tool_use');
                } catch(e) {}
            }
            return;
        }

        if (data.type === 'done') {
            _streamSource.close();
            // Task finished â€” check if it was an orphan (no live messages after history)
            if (!historyDone) {
                // Stream ended before history_end â€” shouldn't happen, just reload
                setTimeout(function() { location.reload(); }, 1000);
                return;
            }
            // Task completed or was never running â€” detect orphan
            if (_streamMsgCount === 0 && orphanWarn && statusHint) {
                statusHint.style.display = 'none';
                orphanWarn.style.display = 'block';
            } else {
                // Normal completion â€” reload to pick up new state
                setTimeout(function() { location.reload(); }, 1500);
            }
            return;
        }

        if (data.type === 'status') {
            _streamSource.close();
            // State changed â€” reload to render new UI
            setTimeout(function() { location.reload(); }, 1000);
            return;
        }

        if (data.type === 'error') {
            appendLogEntry(logList, {role: 'error', content: data.message || 'Unknown error'});
            return;
        }
    };

    _streamSource.onerror = function() {
        _streamSource.close();
        // Connection lost â€” fall back to polling
        setTimeout(function() { location.reload(); }, 5000);
    };
}

function appendLogEntry(container, data) {
    if (!container) return;
    var div = document.createElement('div');
    div.style.cssText = 'padding:4px 0; border-bottom:1px solid #313244; line-height:1.5;';

    var role = data.role;
    var content = data.content || '';
    var roleLabel, roleColor;

    if (role === 'assistant') {
        roleLabel = 'AI';
        roleColor = '#89b4fa';
        // Truncate very long messages
        if (content.length > 500) content = content.substring(0, 500) + '...';
    } else if (role === 'tool') {
        roleLabel = 'ğŸ”§';
        roleColor = '#a6e3a1';
        // Parse tool JSON for nicer display
        try {
            var toolData = JSON.parse(content);
            content = toolData.tool;
            if (toolData.input) {
                var inputStr = typeof toolData.input === 'string' ? toolData.input : JSON.stringify(toolData.input);
                if (inputStr.length > 200) inputStr = inputStr.substring(0, 200) + '...';
                content += ' â†’ ' + inputStr;
            }
        } catch(e) {
            if (content.length > 300) content = content.substring(0, 300) + '...';
        }
    } else if (role === 'user') {
        roleLabel = 'ç”¨æˆ·';
        roleColor = '#f9e2af';
    } else if (role === 'error') {
        roleLabel = 'é”™è¯¯';
        roleColor = '#f38ba8';
    } else {
        roleLabel = role;
        roleColor = '#cdd6f4';
    }

    div.innerHTML = '<span style="color:' + roleColor + '; font-weight:600; margin-right:8px;">[' + roleLabel + ']</span>'
        + '<span style="color:#cdd6f4;">' + escapeHtml(content) + '</span>';
    container.appendChild(div);
    scrollLog();
}

function scrollLog() {
    var panel = document.getElementById('ai-log-panel');
    if (panel) panel.scrollTop = panel.scrollHeight;
}

/* ------------------------------------------------------------------ */
/* Original functions (unchanged)                                      */
/* ------------------------------------------------------------------ */

async function submitAnswers() {
    var fields = document.querySelectorAll('.answer-field');
    var answers = {};
    fields.forEach(function(f) {
        var val = f.value.trim();
        if (val) answers[f.dataset.id] = val;
    });
    if (fields.length > 0 && Object.keys(answers).length === 0) {
        showToast('è¯·è‡³å°‘å›ç­”ä¸€ä¸ªé—®é¢˜', 'error');
        return;
    }
    await apiCall('/api/stories/' + STORY_ID + '/answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ answers: answers })
    });
    showToast('å›ç­”å·²æäº¤');
    location.reload();
}

async function skipClarify() {
    await apiCall('/api/stories/' + STORY_ID + '/answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ answers: {} })
    });
    showToast('å·²è·³è¿‡æ¾„æ¸…ï¼Œè¿›å…¥è§„åˆ’é˜¶æ®µ');
    location.reload();
}

async function generatePlan() {
    try {
        await apiCall('/api/stories/' + STORY_ID + '/generate-plan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        showToast('æ–¹æ¡ˆç”Ÿæˆå·²å¯åŠ¨ï¼ŒAI å¤„ç†ä¸­...');
        location.reload();
    } catch(e) {
        showToast('è¯·æ±‚å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
}

async function confirmPlan(confirmed) {
    var feedback = null;
    if (!confirmed) {
        feedback = prompt('è¯·è¾“å…¥åé¦ˆæ„è§ï¼Œå‘Šè¯‰ AI å“ªé‡Œéœ€è¦æ”¹è¿›ï¼š');
        if (feedback === null) return;
    }
    await apiCall('/api/stories/' + STORY_ID + '/confirm-plan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ confirmed: confirmed, feedback: feedback })
    });
    if (confirmed) {
        showToast('æ–¹æ¡ˆå·²ç¡®è®¤ï¼ŒAI å¼€å§‹ç¼–ç ');
    } else {
        showToast('æ–¹æ¡ˆå·²é©³å›ï¼ŒAI æ­£åœ¨é‡æ–°è§„åˆ’...');
    }
    location.reload();
}

function showReviseModal() { document.getElementById('revise-modal').style.display = 'flex'; }
function hideReviseModal() { document.getElementById('revise-modal').style.display = 'none'; }

async function submitRevise() {
    var mode = document.getElementById('revise-mode').value;
    var prompt_text = document.getElementById('revise-prompt').value.trim() || null;
    await apiCall('/api/stories/' + STORY_ID + '/revise', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mode: mode, prompt: prompt_text })
    });
    showToast('ä¿®æ”¹è¯·æ±‚å·²æäº¤');
    hideReviseModal();
    location.reload();
}

async function triggerTest() {
    await apiCall('/api/stories/' + STORY_ID + '/test', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
    });
    showToast('æµ‹è¯•å·²è§¦å‘');
    location.reload();
}

async function triggerMerge() {
    if (!confirm('ç¡®å®šåˆå¹¶æ­¤ PRï¼Ÿ')) return;
    await apiCall('/api/stories/' + STORY_ID + '/merge', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
    });
    showToast('PR å·²åˆå¹¶');
    location.reload();
}

async function verifyPass() {
    if (!confirm('éªŒè¯é€šè¿‡ï¼Œç¡®å®šåˆå¹¶æ­¤ PRï¼Ÿ')) return;
    await apiCall('/api/stories/' + STORY_ID + '/merge', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
    });
    showToast('éªŒè¯é€šè¿‡ï¼ŒPR å·²åˆå¹¶');
    location.reload();
}

function showVerifyFailModal() { document.getElementById('verify-fail-modal').style.display = 'flex'; }
function hideVerifyFailModal() { document.getElementById('verify-fail-modal').style.display = 'none'; }

async function submitVerifyFail() {
    var feedback = document.getElementById('verify-feedback').value.trim();
    if (!feedback) { showToast('è¯·å¡«å†™é—®é¢˜æè¿°', 'error'); return; }
    await apiCall('/api/stories/' + STORY_ID + '/revise', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mode: 'prompt', prompt: '[éªŒè¯ä¸é€šè¿‡] ' + feedback })
    });
    showToast('å·²æäº¤ä¿®æ”¹è¯·æ±‚');
    hideVerifyFailModal();
    location.reload();
}

async function backToReview() {
    await apiCall('/api/stories/' + STORY_ID + '/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ target_status: 'reviewing' })
    });
    showToast('å·²è¿”å›å®¡æŸ¥é˜¶æ®µ');
    location.reload();
}

async function resetToPlanning() {
    if (!confirm('ç¡®å®šå›é€€åˆ°è§„åˆ’é˜¶æ®µï¼Ÿå½“å‰ç¼–ç è¿›åº¦å°†ä¸¢å¤±ã€‚')) return;
    await apiCall('/api/stories/' + STORY_ID + '/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ target_status: 'planning' })
    });
    showToast('å·²å›é€€åˆ°è§„åˆ’é˜¶æ®µ');
    location.reload();
}

async function stopTask() {
    if (!confirm('ç¡®å®šç´§æ€¥åœæ­¢å½“å‰ AI ä»»åŠ¡ï¼Ÿ')) return;
    try {
        if (_streamSource) _streamSource.close();
        await apiCall('/api/stories/' + STORY_ID + '/stop', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        showToast('å·²åœæ­¢å½“å‰ä»»åŠ¡');
        location.reload();
    } catch(e) {
        showToast('åœæ­¢å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
}

async function retryPR() {
    try {
        showToast('æ­£åœ¨é‡è¯•åˆ›å»º PR...');
        await apiCall('/api/stories/' + STORY_ID + '/retry-pr', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        showToast('PR åˆ›å»ºæˆåŠŸ');
        location.reload();
    } catch(e) {
        showToast('é‡è¯•å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
}

async function resetToReviewing() {
    if (!confirm('ç¡®å®šå›é€€åˆ°å®¡æŸ¥é˜¶æ®µï¼Ÿ')) return;
    await apiCall('/api/stories/' + STORY_ID + '/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ target_status: 'reviewing' })
    });
    showToast('å·²å›é€€åˆ°å®¡æŸ¥é˜¶æ®µ');
    location.reload();
}

function showNewRoundModal() { document.getElementById('new-round-modal').style.display = 'flex'; }
function hideNewRoundModal() { document.getElementById('new-round-modal').style.display = 'none'; }

async function submitNewRound() {
    var type = document.getElementById('round-type').value;
    var requirement = document.getElementById('round-requirement').value.trim() || null;
    await apiCall('/api/stories/' + STORY_ID + '/new-round', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ type: type, requirement: requirement })
    });
    showToast('æ–°ä¸€è½®å·²å¼€å§‹');
    hideNewRoundModal();
    location.reload();
}

function refreshLogs() {
    var logList = document.getElementById('ai-log-list');
    if (!logList) return;
    logList.innerHTML = '';
    var es = new EventSource('/api/stories/' + STORY_ID + '/logs');
    var messages = [];
    es.onmessage = function(event) {
        var data = JSON.parse(event.data);
        if (data.type === 'done') { es.close(); if (messages.length === 0) logList.innerHTML = '<div style="color:#6c7086;">æš‚æ— æ¶ˆæ¯</div>'; return; }
        if (data.type === 'info') { logList.innerHTML = '<div style="color:#6c7086;">' + data.message + '</div>'; es.close(); return; }
        messages.push(data);
        appendLogEntry(logList, data);
    };
    es.onerror = function() { es.close(); };
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}

async function closeStory() {
    if (!confirm('ç¡®å®šå…³é—­æ­¤éœ€æ±‚ï¼Ÿå…³é—­åå¯åœ¨é¡¹ç›®é¡µé¢é‡æ–°æ‰“å¼€ã€‚')) return;
    try {
        await apiCall('/api/stories/' + STORY_ID + '/close', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'
        });
        showToast('éœ€æ±‚å·²å…³é—­');
        location.reload();
    } catch(e) {
        showToast('å…³é—­å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
}

function toggleAILog() {
    var panel = document.getElementById('ai-log-panel');
    if (!panel) return;
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        refreshLogs();
    } else {
        panel.style.display = 'none';
    }
}
</script>
{% endblock %}

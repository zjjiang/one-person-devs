{% extends "base.html" %}
{% block title %}OPD - {{ "编辑项目" if project else "创建项目" }}{% endblock %}
{% block content %}
<div class="page-header">
  <h1>{{ "编辑项目" if project else "创建项目" }}</h1>
</div>

<form id="project-form" class="form">
  <div class="form-group">
    <label for="name">项目名称</label>
    <input type="text" id="name" name="name" required
           value="{{ project.name if project else '' }}">
  </div>
  <div class="form-group">
    <label for="repo_url">仓库地址</label>
    <input type="text" id="repo_url" name="repo_url" required
           placeholder="https://github.com/org/repo"
           value="{{ project.repo_url if project else '' }}">
  </div>
  <div class="form-group">
    <label for="description">项目描述</label>
    <textarea id="description" name="description" rows="3">{{ project.description if project else '' }}</textarea>
  </div>
  <div class="form-group">
    <label for="tech_stack">技术栈</label>
    <textarea id="tech_stack" name="tech_stack" rows="2"
              placeholder="例如: Python, FastAPI, React">{{ project.tech_stack if project else '' }}</textarea>
  </div>
  <div class="form-group">
    <label for="architecture">架构说明</label>
    <textarea id="architecture" name="architecture" rows="3">{{ project.architecture if project else '' }}</textarea>
  </div>
  <div class="form-actions">
    <button type="submit" class="btn btn-primary">保存</button>
    <a href="/" class="btn btn-secondary">取消</a>
  </div>
</form>

<script>
document.getElementById('project-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    name: document.getElementById('name').value,
    repo_url: document.getElementById('repo_url').value,
    description: document.getElementById('description').value,
    tech_stack: document.getElementById('tech_stack').value,
    architecture: document.getElementById('architecture').value,
  };
  {% if project %}
  const url = '/api/projects/{{ project.id }}';
  const method = 'PUT';
  {% else %}
  const url = '/api/projects';
  const method = 'POST';
  {% endif %}
  const res = await fetch(url, {
    method, headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data),
  });
  const result = await res.json();
  if (result.id) {
    window.location.href = '/projects/' + result.id;
  }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}

{% block header %}
<div class="page-header">
    <h1>{{ project.name }}</h1>
    <a href="/projects/{{ project.id }}/stories/new" class="btn btn-primary">+ 新建需求</a>
</div>
{% endblock %}

{% block content %}
<!-- Project info -->
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>项目信息</h2>
        </div>
        <div class="card-body">
            <dl class="info-grid">
                <dt>仓库地址</dt>
                <dd><a href="{{ project.repo_url }}" target="_blank">{{ project.repo_url }}</a></dd>
                <dt>项目描述</dt>
                <dd>{{ project.description or "---" }}</dd>
                <dt>技术栈</dt>
                <dd>{{ project.tech_stack or "---" }}</dd>
                <dt>架构说明</dt>
                <dd>{{ project.architecture or "---" }}</dd>
                <dt>创建时间</dt>
                <dd>{{ project.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
            </dl>
        </div>
    </div>
</div>

<!-- Rules -->
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>规则</h2>
            <button class="btn btn-sm btn-primary" onclick="toggleAddRule()">+ 添加规则</button>
        </div>
        <div id="add-rule-form" style="display:none; padding:16px; border-bottom:1px solid var(--border);">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
                <div class="form-group" style="margin-bottom:0; flex:0 0 160px;">
                    <label for="rule-category">分类</label>
                    <select id="rule-category" class="form-control">
                        <option value="coding">coding</option>
                        <option value="architecture">architecture</option>
                        <option value="testing">testing</option>
                        <option value="git">git</option>
                        <option value="forbidden">forbidden</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:0; flex:1; min-width:200px;">
                    <label for="rule-content">内容</label>
                    <input id="rule-content" class="form-control" placeholder="规则内容...">
                </div>
                <button class="btn btn-primary btn-sm" onclick="addRule()">保存</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleAddRule()">取消</button>
            </div>
        </div>
        <div class="card-body" style="padding:0;">
            {% if project.rules %}
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>分类</th>
                            <th>内容</th>
                            <th>启用</th>
                            <th style="width:80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="rules-tbody">
                        {% for rule in project.rules %}
                        <tr id="rule-{{ rule.id }}">
                            <td><span class="badge badge-{{ rule.category.value }}">{{ rule.category.value }}</span></td>
                            <td>{{ rule.content }}</td>
                            <td>{{ "是" if rule.enabled else "否" }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteRule('{{ rule.id }}')">删除</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Skills -->
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>技能</h2>
            <button class="btn btn-sm btn-primary" onclick="toggleAddSkill()">+ 添加技能</button>
        </div>
        <div id="add-skill-form" style="display:none; padding:16px; border-bottom:1px solid var(--border);">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
                <div class="form-group" style="margin-bottom:0; flex:0 0 160px;">
                    <label for="skill-name">名称</label>
                    <input id="skill-name" class="form-control" placeholder="技能名称">
                </div>
                <div class="form-group" style="margin-bottom:0; flex:1; min-width:160px;">
                    <label for="skill-command">命令</label>
                    <input id="skill-command" class="form-control" placeholder="例如：npm run lint">
                </div>
                <div class="form-group" style="margin-bottom:0; flex:0 0 180px;">
                    <label for="skill-trigger">触发方式</label>
                    <select id="skill-trigger" class="form-control">
                        <option value="manual">manual</option>
                        <option value="auto_after_coding">auto_after_coding</option>
                        <option value="auto_before_pr">auto_before_pr</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-sm" onclick="addSkill()">保存</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleAddSkill()">取消</button>
            </div>
        </div>
        <div class="card-body" style="padding:0;">
            {% if project.skills %}
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>命令</th>
                            <th>触发方式</th>
                            <th style="width:80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="skills-tbody">
                        {% for skill in project.skills %}
                        <tr id="skill-{{ skill.id }}">
                            <td>{{ skill.name }}</td>
                            <td><code>{{ skill.command }}</code></td>
                            <td><span class="badge badge-created">{{ skill.trigger.value }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteSkill('{{ skill.id }}')">删除</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stories -->
<div class="section">
    <div class="card">
        <div class="card-header">
            <h2>需求列表</h2>
            <a href="/projects/{{ project.id }}/stories/new" class="btn btn-sm btn-primary">+ 新建需求</a>
        </div>
        <div class="card-body" style="padding:0;">
            {% if stories %}
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>标题</th>
                            <th>状态</th>
                            <th>轮次</th>
                            <th>创建时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for story in stories %}
                        <tr>
                            <td><a href="/stories/{{ story.id }}">{{ story.title }}</a></td>
                            <td><span class="badge badge-{{ story.status.value }}">{{ story.status.value }}</span></td>
                            <td>{{ story.current_round }}</td>
                            <td>{{ story.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var PROJECT_ID = "{{ project.id }}";

function toggleAddRule() {
    var el = document.getElementById('add-rule-form');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function toggleAddSkill() {
    var el = document.getElementById('add-skill-form');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function addRule() {
    var category = document.getElementById('rule-category').value;
    var content = document.getElementById('rule-content').value.trim();
    if (!content) { showToast('规则内容不能为空', 'error'); return; }
    await apiCall('/api/projects/' + PROJECT_ID + '/rules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ project_id: PROJECT_ID, category: category, content: content, enabled: true })
    });
    showToast('规则已添加');
    location.reload();
}

async function deleteRule(ruleId) {
    if (!confirm('确定删除此规则？')) return;
    await apiCall('/api/projects/' + PROJECT_ID + '/rules/' + ruleId, { method: 'DELETE' });
    showToast('规则已删除');
    var row = document.getElementById('rule-' + ruleId);
    if (row) row.remove();
}

async function addSkill() {
    var name = document.getElementById('skill-name').value.trim();
    var command = document.getElementById('skill-command').value.trim();
    var trigger = document.getElementById('skill-trigger').value;
    if (!name || !command) { showToast('名称和命令为必填项', 'error'); return; }
    await apiCall('/api/projects/' + PROJECT_ID + '/skills', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ project_id: PROJECT_ID, name: name, command: command, trigger: trigger })
    });
    showToast('技能已添加');
    location.reload();
}

async function deleteSkill(skillId) {
    if (!confirm('确定删除此技能？')) return;
    await apiCall('/api/projects/' + PROJECT_ID + '/skills/' + skillId, { method: 'DELETE' });
    showToast('技能已删除');
    var row = document.getElementById('skill-' + skillId);
    if (row) row.remove();
}
</script>
{% endblock %}
